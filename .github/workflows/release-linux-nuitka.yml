name: Release - Nuitka standalone executables (Linux)

on:
  push:
    branches: [ 'release/*' ]
    tags: ['v*']
  pull_request:
    branches: [ 'release/*' ]
  release:
    types: [published]

jobs:
  build-nuitka:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies (patchelf, libjpeg/openjpeg)
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf libjpeg-dev libopenjp2-7-dev zlib1g-dev

      - name: Install package with dependencies and Nuitka
        run: |
          python -m pip install --upgrade pip
          pip install -e .[full]
          pip install 'nuitka==2.8' wheel

      - name: Build mcscripter (onefile)
        run: |
          python -m nuitka \
            --standalone --onefile \
            --include-data-file=pymchelper/_version.py=pymchelper/_version.py \
            --nofollow-import-to=pytrip \
            --enable-plugin=no-qt \
            --output-filename=mcscripter \
            pymchelper/utils/mcscripter.py

      - name: Build plan2sobp (onefile)
        run: |
          python -m nuitka \
            --standalone --onefile \
            --include-data-file=pymchelper/_version.py=pymchelper/_version.py \
            --nofollow-import-to=pytrip \
            --include-module=pydicom.encoders.gdcm \
            --include-module=pydicom.encoders.pylibjpeg \
            --include-module=scipy.spatial.transform._rotation_groups \
            --enable-plugin=no-qt \
            --output-filename=plan2sobp \
            pymchelper/utils/radiotherapy/plan.py

      - name: Build runmc (onefile)
        run: |
          python -m nuitka \
            --standalone --onefile \
            --include-data-file=pymchelper/_version.py=pymchelper/_version.py \
            --include-data-file=pymchelper/flair/db/card.ini=pymchelper/flair/db/card.ini \
            --include-data-file=pymchelper/flair/db/card.db=pymchelper/flair/db/card.db \
            --nofollow-import-to=pytrip \
            --enable-plugin=no-qt \
            --output-filename=runmc \
            pymchelper/utils/runmc.py

      - name: Build convertmc (onefile)
        run: |
          python -m nuitka \
            --standalone --onefile \
            --include-data-file=pymchelper/_version.py=pymchelper/_version.py \
            --include-data-file=pymchelper/flair/db/card.ini=pymchelper/flair/db/card.ini \
            --include-data-file=pymchelper/flair/db/card.db=pymchelper/flair/db/card.db \
            --nofollow-import-to=pytrip \
            --nofollow-import-to=scipy \
            --enable-plugin=no-qt \
            --output-filename=convertmc \
            pymchelper/run.py

      - name: List generated executables with sizes
        run: |
          ls -lh mcscripter plan2sobp runmc convertmc
          du -h mcscripter plan2sobp runmc convertmc

      - name: Test mcscripter executable
        run: ./mcscripter --version

      - name: Test plan2sobp executable
        run: ./plan2sobp --version

      - name: Test runmc executable
        run: ./runmc --version

      - name: Test convertmc executable
        run: ./convertmc --version

      - name: Archive executables as artifacts
        uses: actions/upload-artifact@v5
        with:
          name: nuitka-executables-linux
          path: |
            ./mcscripter
            ./plan2sobp
            ./runmc
            ./convertmc

  test-nuitka-executables:
    runs-on: ubuntu-latest
    needs: [build-nuitka]
    strategy:
      matrix:
        docker-tag:
          - 'debian:11'
          - 'debian:12'
          - 'debian:stable'
          - 'ubuntu:20.04'
          - 'ubuntu:22.04'
          - 'ubuntu:24.04'
          - 'fedora:39'
          - 'fedora:40'
          - 'fedora:41'

    steps:
      - uses: actions/download-artifact@v6
        with:
          name: nuitka-executables-linux
          path: ./executables

      - name: Test mcscripter on ${{ matrix.docker-tag }}
        run: docker run --volume `pwd`/executables:/test/ ${{ matrix.docker-tag }} /test/mcscripter --version

      - name: Test plan2sobp on ${{ matrix.docker-tag }}
        run: docker run --volume `pwd`/executables:/test/ ${{ matrix.docker-tag }} /test/plan2sobp --version

      - name: Test runmc on ${{ matrix.docker-tag }}
        run: docker run --volume `pwd`/executables:/test/ ${{ matrix.docker-tag }} /test/runmc --version

      - name: Test convertmc on ${{ matrix.docker-tag }}
        run: docker run --volume `pwd`/executables:/test/ ${{ matrix.docker-tag }} /test/convertmc --version

  upload-nuitka-executables:
    runs-on: ubuntu-latest
    needs: [build-nuitka, test-nuitka-executables]
    steps:
      - uses: actions/download-artifact@v6
        with:
          name: nuitka-executables-linux
          path: ./dist-nuitka-linux

      - name: Add artifact with executables to the release
        uses: ncipollo/release-action@v1.20.0
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          allowUpdates:  true
          artifacts: './dist-nuitka-linux/*'
          token:  ${{ secrets.GITHUB_TOKEN }}
